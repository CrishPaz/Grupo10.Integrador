{
  "name": "Generación Automática de Facturas",
  "nodes": [
    {
      "name": "Webhook Admisión Completada",
      "type": "n8n-nodes-base.webhook",
      "position": [300, 200],
      "parameters": {
        "httpMethod": "POST",
        "path": "admission-completed",
        "responseMode": "responseNode"
      }
    },
    {
      "name": "Obtener Datos Admisión",
      "type": "n8n-nodes-base.httpRequest",
      "position": [500, 200],
      "parameters": {
        "method": "GET",
        "url": "={{$json.admission_url}}",
        "authentication": "genericCredentialType"
      }
    },
    {
      "name": "Calcular Montos",
      "type": "n8n-nodes-base.function",
      "position": [700, 200],
      "parameters": {
        "functionCode": "const admission = $input.first().json;\n\n// Calcular montos según tipo de examen\nconst tarifas = {\n  'INGRESO': 250.00,\n  'PERIODICO': 180.00,\n  'RETIRO': 150.00,\n  'REINTEGRO': 200.00\n};\n\nconst subtotal = tarifas[admission.tipo_examen] || 200.00;\nconst igv = subtotal * 0.18;\nconst total = subtotal + igv;\n\nreturn {\n  admission_id: admission.id,\n  paciente: admission.paciente,\n  empresa: admission.empresa,\n  tipo_examen: admission.tipo_examen,\n  subtotal,\n  igv,\n  total,\n  items: [\n    {\n      descripcion: `Evaluación Ocupacional - ${admission.tipo_examen}`,\n      cantidad: 1,\n      unidad_medida: 'ZZ',\n      precio_unitario: subtotal,\n      subtotal: subtotal,\n      igv_monto: igv,\n      total: total\n    }\n  ]\n};"
      }
    },
    {
      "name": "Crear Factura en Sistema",
      "type": "n8n-nodes-base.httpRequest",
      "position": [900, 200],
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3000/api/facturacion/facturas/create",
        "authentication": "genericCredentialType",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "admision_id",
              "value": "={{$json.admission_id}}"
            },
            {
              "name": "tipo_comprobante",
              "value": "={{$json.empresa ? '01' : '03'}}"
            },
            {
              "name": "receptor",
              "value": "={{\n  $json.empresa\n    ? {\n        tipo_documento: '6',\n        numero_documento: $json.empresa.ruc,\n        razon_social: $json.empresa.razon_social,\n        direccion: $json.empresa.direccion,\n        email: $json.empresa.contacto_email\n      }\n    : {\n        tipo_documento: '1',\n        numero_documento: $json.paciente.usuario.dni,\n        razon_social: `${$json.paciente.usuario.nombres} ${$json.paciente.usuario.apellidos}`,\n        email: $json.paciente.usuario.email\n      }\n}}"
            },
            {
              "name": "items",
              "value": "={{$json.items}}"
            }
          ]
        }
      }
    },
    {
      "name": "Enviar Factura por Email",
      "type": "n8n-nodes-base.emailSend",
      "position": [1100, 200],
      "parameters": {
        "fromEmail": "facturacion@saludlaboral.pe",
        "toEmail": "={{$json.receptor.email}}",
        "subject": "Factura Electrónica - Clínica Salud Laboral",
        "text": "Estimado cliente,\\n\\nAdjunto encontrará su factura electrónica generada por nuestros servicios.\\n\\nDetalles:\\n- Número: {{$json.serie}}-{{$json.numero}}\\n- Fecha: {{$json.fecha_emision}}\\n- Monto: S/ {{$json.total}}\\n\\nPuede descargar el comprobante desde nuestro portal o contactarnos para cualquier consulta.\\n\\nSaludos,\\nClínica Salud Laboral",
        "attachments": {
          "attachments": [
            {
              "name": "factura_{{=$json.serie}}_{{=$json.numero}}.pdf",
              "content": "={{$json.pdf_base64}}",
              "type": "application/pdf"
            }
          ]
        }
      }
    },
    {
      "name": "Registrar en Sistema Contable",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1300, 200],
      "parameters": {
        "method": "POST",
        "url": "http://sistema-contable/api/asientos",
        "authentication": "genericCredentialType",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "fecha",
              "value": "={{$json.fecha_emision}}"
            },
            {
              "name": "comprobante",
              "value": "={{$json.tipo_comprobante === '01' ? 'FACTURA' : 'BOLETA'}}"
            },
            {
              "name": "numero",
              "value": "={{`${$json.serie}-${$json.numero}`}}"
            },
            {
              "name": "cliente",
              "value": "={{$json.receptor.razon_social}}"
            },
            {
              "name": "monto",
              "value": "={{$json.total}}"
            },
            {
              "name": "cuenta_ingresos",
              "value": "701101"
            },
            {
              "name": "cuenta_igv",
              "value": "401111"
            }
          ]
        }
      }
    },
    {
      "name": "Respuesta Exitosa",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1500, 200],
      "parameters": {
        "responseBody": {
          "success": true,
          "message": "Factura generada y enviada exitosamente",
          "factura_id": "={{$json.id}}",
          "numero": "={{`${$json.serie}-${$json.numero}`}}"
        }
      }
    }
  ]
}
